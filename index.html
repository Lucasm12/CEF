<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verificador de Combinações – Lotofácil</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827ee; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#22c55e; /* green-500 */
      --accent-2:#3b82f6; /* blue-500 */
      --danger:#ef4444; /* red-500 */
      --warn:#f59e0b; /* amber-500 */
      --border:#1f2937; /* gray-800 */
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text); background: radial-gradient(1200px 800px at 15% 15%,#0b1022,transparent),linear-gradient(180deg,#0a0f1f, #0f172a);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:32px;
    }
    .app{width:min(980px,100%);}
    .card{
      background: linear-gradient(180deg, #0f172a, #0b1224);
      border:1px solid var(--border); border-radius:18px; padding:22px; box-shadow:0 10px 30px #00000055;
    }
    h1{font-size: clamp(22px, 3vw, 30px); margin:0 0 8px 0}
    p.lead{color:var(--muted); margin:0 0 16px}
    .grid{display:grid; gap:14px}
    .grid.cols{grid-template-columns: 1.3fr .7fr}
    @media (max-width:820px){.grid.cols{grid-template-columns: 1fr}}

    /* Upload */
    .drop{
      border:1px dashed #334155; border-radius:14px; padding:16px; background:#0b1328; transition:.2s ease; cursor:pointer;
    }
    .drop:hover{border-color:#3b82f6; background:#0b1531}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); font-size:12px}

    /* Números */
    .nums{display:grid; grid-template-columns: repeat(5, 1fr); gap:10px}
    .num{appearance:none; border:1px solid #25304a; background:#0e1630; color:#cbd5e1; padding:12px; border-radius:12px; text-align:center; font-weight:600; cursor:pointer; transition:.15s; user-select:none}
    .num:hover{transform: translateY(-1px)}
    .num.active{background: #12391d; border-color:#14532d; color:#bbf7d0; box-shadow: inset 0 0 0 2px #14532d}
    .num.disabled{opacity:.5; pointer-events:none}

    /* Buttons */
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    button{
      appearance:none; background:#0b1328; border:1px solid var(--border); color:var(--text); padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:.15s
    }
    button:hover{transform:translateY(-1px); border-color:#334155}
    button.primary{background:#0c1a36; border-color:#1d4ed8}
    button.primary:disabled{opacity:.5; pointer-events:none}
    .ghost{background:transparent}

    .stats{display:flex; gap:12px; flex-wrap:wrap; margin:8px 0 0}
    .stat{border:1px solid var(--border); padding:8px 10px; border-radius:10px; color:var(--muted); font-size:13px}

    .result{margin-top:14px; padding:14px; border-radius:12px; border:1px solid var(--border); background:#0b1328}
    .result.ok{border-color:#14532d; background:#0f1f17}
    .result.bad{border-color:#3f1d20; background:#1a0f12}

    .small{font-size:12px; color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Verificador de Combinações • Lotofácil</h1>
      <p class="lead">Carregue um <strong>CSV</strong> ou <strong>JSON</strong> com os sorteios oficiais (CEF) e selecione sua combinação (15 dezenas entre 1 e 25). O app dirá se ela já foi sorteada.</p>

      <div class="grid cols" role="region" aria-label="Área principal">
        <!-- Coluna esquerda: upload + status -->
        <section aria-label="Carregar base de dados">
          <label for="file" class="drop" id="drop">
            <div class="row">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 16V4m0 12 3.5-3.5M12 16 8.5 12.5M6 20h12a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2h-1M6 20a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h1" stroke="#94a3b8" stroke-width="1.5" stroke-linecap="round"/></svg>
              <div>
                <div style="font-weight:700">Solte ou selecione seu arquivo (.csv ou .json)</div>
                <div class="small">Aceita múltiplos formatos de CSV; para JSON, pode ser uma <em>array</em> de dezenas ou objetos com campo <code class="mono">dezenas</code>.</div>
              </div>
            </div>
            <input id="file" type="file" accept=".csv,.json,text/csv,application/json" multiple class="hidden" />
          </label>

          <div class="stats" id="stats">
            <div class="stat" id="loaded">Base não carregada</div>
            <div class="stat" id="keys">—</div>
          </div>

          <details style="margin-top:10px">
            <summary class="small">Não tem arquivo agora? Use a base de exemplo (apenas para testes)</summary>
            <div class="row" style="margin-top:8px">
              <button id="loadDemo">Carregar exemplo</button>
              <span class="small">Inclui 3 sorteios fictícios para testar a lógica.</span>
            </div>
          </details>
        </section>

        <!-- Coluna direita: seleção da combinação -->
        <section aria-label="Selecionar combinação">
          <div class="row" style="justify-content:space-between; align-items:center">
            <div class="badge" id="selCount">Selecionadas: 0/15</div>
            <div class="row">
              <button class="ghost" id="limpar">Limpar</button>
              <button class="ghost" id="preencherEx">Preencher exemplo</button>
            </div>
          </div>

          <div class="nums" id="nums" aria-label="Grade de dezenas"></div>

          <div class="actions" style="margin-top:12px">
            <button class="primary" id="verificar" disabled>Verificar combinação</button>
            <button id="copiar" title="Copiar dezenas selecionadas">Copiar</button>
          </div>

          <div id="saida" class="result hidden" aria-live="polite"></div>
        </section>
      </div>

      <p class="small" style="margin-top:16px">Dica: você também pode colar/arrastar planilhas direto aqui. O parser é tolerante a cabeçalhos e formatos diferentes; ele extrai as 15 dezenas válidas (1–25) por linha.</p>
    </div>
  </div>

  <script>
    // Utilidades -------------------------------------------------------------
    const pad = n => String(n).padStart(2,'0');
    const canonical = arr => arr.map(pad).sort().join('-');

    // Estruturas em memória
    const index = new Map(); // key: "01-...-25" -> meta[]
    let totalRegistros = 0;

    // UI refs
    const fileInput = document.getElementById('file');
    const drop = document.getElementById('drop');
    const loaded = document.getElementById('loaded');
    const keys = document.getElementById('keys');
    const nums = document.getElementById('nums');
    const selCount = document.getElementById('selCount');
    const saida = document.getElementById('saida');
    const verificarBtn = document.getElementById('verificar');
    const limparBtn = document.getElementById('limpar');
    const copiarBtn = document.getElementById('copiar');
    const preencherExBtn = document.getElementById('preencherEx');
    const loadDemoBtn = document.getElementById('loadDemo');

    // Construir grade 1..25
    const selected = new Set();
    for (let i=1;i<=25;i++){
      const b = document.createElement('button');
      b.type='button'; b.className='num'; b.textContent=pad(i); b.dataset.v=i;
      b.addEventListener('click',()=>toggleNum(i,b));
      nums.appendChild(b);
    }

    function toggleNum(n, el){
      if (selected.has(n)) { selected.delete(n); el.classList.remove('active'); }
      else {
        if (selected.size>=15) return; // trava em 15
        selected.add(n); el.classList.add('active');
      }
      updateSelectionUI();
    }

    function updateSelectionUI(){
      selCount.textContent = `Selecionadas: ${selected.size}/15`;
      verificarBtn.disabled = selected.size!==15 || index.size===0;
      // quando chegar em 15, desabilita restantes p/ evitar confusão
      const lock = selected.size>=15;
      document.querySelectorAll('.num').forEach(btn=>{
        btn.classList.toggle('disabled', lock && !btn.classList.contains('active'));
      });
      // limpar resultado anterior
      saida.classList.add('hidden'); saida.textContent='';
    }

    limparBtn.addEventListener('click',()=>{
      selected.clear();
      document.querySelectorAll('.num').forEach(b=>b.classList.remove('active','disabled'));
      updateSelectionUI();
    });

    copiarBtn.addEventListener('click', async ()=>{
      const arr = [...selected].map(pad).sort();
      if (!arr.length) return;
      try { await navigator.clipboard.writeText(arr.join(',')); copiarBtn.textContent='Copiado!'; setTimeout(()=>copiarBtn.textContent='Copiar',1200); } catch(e){}
    });

    preencherExBtn.addEventListener('click',()=>{
      // exemplo simples para teste rápido
      const exemplo = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];
      limparBtn.click();
      exemplo.forEach(n=>{
        const btn = [...document.querySelectorAll('.num')].find(x=>+x.dataset.v===n);
        if (btn) toggleNum(n, btn);
      });
    });

    verificarBtn.addEventListener('click',()=>{
      const arr = [...selected];
      if (arr.length!==15) return;
      const key = canonical(arr);
      const metas = index.get(key);
      if (metas){
        saida.className = 'result ok';
        const ocorrencias = metas.map(m => m.rotulo).join(', ');
        saida.innerHTML = `<strong>✅ Já foi sorteada!</strong><br><span class="small">Combinação ${key}. Ocorrências: ${ocorrencias||'—'}.</span>`;
      } else {
        saida.className = 'result bad';
        saida.innerHTML = `<strong>❌ Não encontrada na base carregada.</strong><br><span class="small">Combinação ${key}.</span>`;
      }
      saida.classList.remove('hidden');
    });

    // Upload / Drag & Drop ---------------------------------------------------
    drop.addEventListener('click',()=>fileInput.click());

    const preventDefaults = e => { e.preventDefault(); e.stopPropagation(); };
    ['dragenter','dragover','dragleave','drop'].forEach(ev=>{
      drop.addEventListener(ev, preventDefaults, false);
    });
    drop.addEventListener('dragover',()=>drop.style.borderColor='#3b82f6');
    drop.addEventListener('dragleave',()=>drop.style.borderColor='#334155');
    drop.addEventListener('drop', (e)=>{
      drop.style.borderColor='#334155';
      const files = e.dataTransfer.files; handleFiles(files);
    });
    fileInput.addEventListener('change', (e)=> handleFiles(e.target.files));

    function handleFiles(fileList){
      const files = [...fileList];
      if (!files.length) return;
      Promise.all(files.map(f=>f.text().then(t=>({name:f.name, text:t})))).then(items=>{
        let add=0;
        items.forEach((it, idx)=>{
          const ext = it.name.split('.').pop().toLowerCase();
          if (ext==='json') add += loadJSON(it.text, it.name);
          else add += loadCSVlike(it.text, it.name);
        });
        totalRegistros += add;
        refreshStats();
        updateSelectionUI();
      }).catch(err=>{
        alert('Erro ao ler arquivos: '+err.message);
      });
    }

    // Parsing ----------------------------------------------------------------
    function loadJSON(text, filename='JSON'){
      let add=0;
      try{
        const data = JSON.parse(text);
        if (Array.isArray(data)){
          data.forEach((row, i)=>{
            let dezenas=[];
            if (Array.isArray(row)) dezenas = row.map(Number).filter(n=>Number.isInteger(n));
            else if (row && Array.isArray(row.dezenas)) dezenas = row.dezenas.map(Number);
            else if (row && typeof row==='object'){
              // tenta pegar campos D1..D15 ou similares
              const nums = Object.values(row).map(Number).filter(x=>Number.isInteger(x));
              dezenas = nums;
            }
            const valid = sanitizeDezenas(dezenas);
            if (valid.length===15) addKey(valid, `${filename}#${i+1}`), add++;
          });
        }
      }catch(e){ console.warn('JSON inválido', e); }
      return add;
    }

    function loadCSVlike(text, filename='CSV'){
      let add=0;
      const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
      const rx = /\b(0?[1-9]|1\d|2[0-5])\b/g; // 1..25 com opcional 0 à esquerda
      lines.forEach((line, i)=>{
        const found = [...line.matchAll(rx)].map(m=>parseInt(m[0],10));
        const valid = sanitizeDezenas(found);
        if (valid.length===15){ addKey(valid, `${filename}#${i+1}`); add++; }
      });
      return add;
    }

    function sanitizeDezenas(nums){
      // mantém apenas 1..25, remove duplicadas, pega as 15 primeiras válidas
      const clean = [];
      const seen = new Set();
      for (const n of nums){
        if (n>=1 && n<=25 && !seen.has(n)){
          clean.push(n); seen.add(n);
          if (clean.length===15) break;
        }
      }
      return clean;
    }

    function addKey(arr, rotulo){
      const key = canonical(arr);
      if (!index.has(key)) index.set(key, [{rotulo}]);
      else index.get(key).push({rotulo});
    }

    function refreshStats(){
      loaded.textContent = `Registros processados: ${totalRegistros}`;
      keys.textContent = `Combinações únicas indexadas: ${index.size}`;
    }

    // Demo -------------------------------------------------------------------
    loadDemoBtn.addEventListener('click', ()=>{
      const demoCSV = `concurso,data,d1,d2,d3,d4,d5,d6,d7,d8,d9,d10,d11,d12,d13,d14,d15\n`+
                      `3000,2025-01-01,01,02,03,04,05,06,07,08,09,10,11,12,13,14,15\n`+
                      `3001,2025-01-02,02,04,06,08,10,12,14,16,18,20,22,24,01,03,05\n`+
                      `3002,2025-01-03,03,06,09,12,15,18,21,24,01,02,04,05,07,08,11`;
      const add = loadCSVlike(demoCSV, 'DEMO');
      totalRegistros += add; refreshStats(); updateSelectionUI();
      alert('Base de exemplo carregada.');
    });

  </script>
</body>
</html>
